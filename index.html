<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Trader PRO V2 | Real-Time Binance</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #0b1120;
            color: #e2e8f0;
            font-family: 'Inter', system-ui, sans-serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.4);
        }

        .neon-red {
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0b1120;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        @keyframes pulse-yellow {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(234, 179, 8, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
            }
        }

        .live-dot {
            animation: pulse-yellow 2s infinite;
        }

        .tf-btn-active {
            background-color: #3b82f6;
            /* blue-500 */
            color: white;
        }

        /* KÃ¢r aktarÄ±mÄ± animasyonu */
        @keyframes profit-flash {
            0% {
                background-color: rgba(34, 197, 94, 0);
            }

            50% {
                background-color: rgba(34, 197, 94, 0.2);
            }

            100% {
                background-color: rgba(34, 197, 94, 0);
            }
        }

        .profit-animate {
            animation: profit-flash 1s ease-out;
        }

        /* Bekleyen kar animasyonu */
        @keyframes pulse-text {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .pulse-text {
            animation: pulse-text 2s infinite;
        }

        .ai-thinking {
            animation: pulse-text 1.5s infinite;
        }
    </style>
</head>

<body class="min-h-screen text-sm md:text-base pb-20">

    <!-- Top Bar -->
    <header
        class="sticky top-0 z-50 flex flex-col md:flex-row justify-between items-center gap-4 bg-[#0b1120]/95 backdrop-blur shadow-lg px-4 md:px-6 py-4 border-b border-white/5">
        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center text-white font-bold text-xl shadow-lg">
                <i class="fa-brands fa-bitcoin"></i>
            </div>
            <div>
                <h1
                    class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-400 tracking-tight">
                    BINANCE <span class="text-white">LIVE TRADER</span>
                </h1>
                <div class="flex items-center gap-2 text-xs text-slate-400">
                    <span class="w-2 h-2 rounded-full bg-yellow-500 live-dot inline-block"></span>
                    <span>Veri KaynaÄŸÄ±: <span class="text-yellow-400 font-mono">BINANCE API</span></span>
                    <span class="mx-1">â€¢</span>
                    <span>KÃ¢r KorumasÄ±: <span class="text-green-400 font-mono font-bold">AKTÄ°F</span></span>
                </div>
            </div>
        </div>

        <div class="flex gap-2 items-stretch">
            <!-- DÃ¼nya Saatleri Paneli (YENÄ°) -->
            <div class="glass-panel px-3 py-1 flex flex-col justify-center min-w-[100px] gap-0.5">
                <div class="flex justify-between items-center text-[9px] text-slate-400 font-mono">
                    <span class="flex items-center gap-1" title="New York"><span
                            class="grayscale opacity-70 text-[10px]">ðŸ‡ºðŸ‡¸</span> NY</span>
                    <span id="clockNY" class="text-slate-300">--:--</span>
                </div>
                <div class="flex justify-between items-center text-[9px] text-slate-400 font-mono">
                    <span class="flex items-center gap-1" title="Tokyo"><span
                            class="grayscale opacity-70 text-[10px]">ðŸ‡¯ðŸ‡µ</span> JP</span>
                    <span id="clockJP" class="text-slate-300">--:--</span>
                </div>
                <div
                    class="flex justify-between items-center text-[9px] text-slate-400 font-mono border-t border-slate-700/50 mt-0.5 pt-0.5">
                    <span class="flex items-center gap-1" title="Ä°stanbul"><span class="text-[10px]">ðŸ‡¹ðŸ‡·</span>
                        TR</span>
                    <span id="clockTR" class="text-yellow-500 font-bold">--:--</span>
                </div>
            </div>

            <div class="glass-panel px-4 py-2 flex flex-col items-center justify-center min-w-[100px]">
                <span class="text-[10px] uppercase text-slate-500 tracking-wider">Piyasa Trendi</span>
                <span id="trendIndicator" class="font-bold text-slate-400">BEKLENÄ°YOR...</span>
            </div>
            <div class="glass-panel px-4 py-2 flex flex-col items-center justify-center min-w-[100px]">
                <span class="text-[10px] uppercase text-slate-500 tracking-wider">RSI (14)</span>
                <span id="rsiIndicator" class="font-bold text-blue-400 font-mono">--.-</span>
            </div>
        </div>

        <div class="flex gap-2 items-center">
            <!-- Haberler Butonu -->
            <button onclick="toggleNewsModal()"
                class="w-10 h-10 flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-blue-400 rounded-lg transition border border-slate-700 relative group"
                title="Piyasa Haberleri & AI Analizi">
                <i class="fa-solid fa-newspaper"></i>
                <span id="newsBadge"
                    class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping hidden"></span>
                <span id="newsBadgeStatic"
                    class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
            </button>

            <!-- Ses AÃ§/Kapa Butonu -->
            <button onclick="realBot.toggleSound()" id="soundToggleBtn"
                class="w-10 h-10 flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-green-400 rounded-lg transition border border-slate-700"
                title="Sesi AÃ§/Kapat">
                <i class="fa-solid fa-volume-high"></i>
            </button>

            <button onclick="realBot.toggle()" id="mainToggleBtn"
                class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition btn-glow font-bold flex items-center gap-2">
                <i class="fa-solid fa-power-off"></i> <span id="btnText">BAÅžLAT</span>
            </button>

            <button onclick="realBot.reset()"
                class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 rounded-lg transition border border-slate-700"
                title="SÄ±fÄ±rla">
                <i class="fa-solid fa-rotate"></i>
            </button>
        </div>
    </header>

    <!-- KaydÄ±rÄ±labilir Ana Ä°Ã§erik -->
    <main class="p-4 md:p-6 space-y-6">

        <!-- Stats Grid (5 Kolon) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">

            <!-- Safe Wallet (GÃœNCELLENDÄ°: AI Otomatik) -->
            <div id="safeWalletCard"
                class="glass-panel p-5 relative overflow-hidden border-green-500/30 bg-green-500/5 transition duration-500">
                <div class="absolute right-2 top-2 text-green-500/20 text-4xl"><i class="fa-solid fa-vault"></i></div>
                <p class="text-green-400 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-1">
                    <i class="fa-solid fa-lock text-[10px]"></i> GÃ¼venli Kasa
                </p>
                <h2 id="securedProfitDisplay" class="text-3xl font-bold text-white tracking-tight mb-0.5">$0.00</h2>
                <!-- YENÄ°: TL KarÅŸÄ±lÄ±ÄŸÄ± GÃ¶stergesi -->
                <p id="securedProfitTryDisplay" class="text-xs text-slate-400 font-mono mb-2 opacity-80">â‰ˆ â‚º0.00</p>

                <div class="flex justify-between items-end mt-2">
                    <span class="text-xs text-slate-500">Ã‡ekilen KÃ¢r</span>
                    <span
                        class="text-[10px] text-green-400/70 bg-green-900/30 px-1.5 py-0.5 rounded border border-green-500/20">AUTO-TRANSFER</span>
                </div>

                <!-- Bekleyen KÃ¢r ve AI Bildirimi -->
                <div id="pendingProfitContainer"
                    class="hidden mt-3 pt-2 border-t border-green-500/20 flex flex-col gap-1">
                    <div class="flex justify-between items-center text-[10px] text-yellow-400 pulse-text">
                        <span><i class="fa-regular fa-clock mr-1"></i>Bekleyen KÃ¢r:</span>
                        <span id="pendingProfitDisplay" class="font-bold">+$0.00</span>
                    </div>
                    <div class="flex items-center gap-1.5 justify-end text-[9px] text-green-400/80 mt-1 ai-thinking">
                        <i class="fa-solid fa-microchip"></i> <span>AI Analiz Ediyor...</span>
                    </div>
                </div>
            </div>

            <!-- Total Assets -->
            <div class="glass-panel p-5 relative overflow-hidden group">
                <div
                    class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/10 rounded-full blur-xl group-hover:bg-yellow-500/20 transition">
                </div>
                <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Aktif VarlÄ±k (Trade)</p>
                <h2 id="portfolioDisplay" class="text-2xl font-bold text-white tracking-tight">$1,000.00</h2>
                <div class="flex justify-between items-end mt-2">
                    <span class="text-xs text-slate-500">PNL (Net)</span>
                    <span id="pnlDisplay" class="text-sm font-bold text-green-400">+0.00%</span>
                </div>
            </div>

            <!-- Cash Wallet -->
            <div class="glass-panel p-5 relative overflow-hidden">
                <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Nakit Bakiye (USDT)</p>
                <h2 id="budgetDisplay" class="text-2xl font-bold text-green-400 font-mono">$1,000.00</h2>
                <div class="w-full bg-slate-700/50 h-1.5 mt-3 rounded-full overflow-hidden">
                    <div id="budgetBar" class="h-full bg-green-500 w-full transition-all duration-500"></div>
                </div>
            </div>

            <!-- Holding -->
            <div class="glass-panel p-5 relative overflow-hidden cursor-pointer hover:bg-slate-800/50 transition group"
                onclick="fillManualInputWithBalance()" title="TÄ±klayarak bakiyeyi manuel iÅŸleme aktar">
                <div
                    class="absolute right-2 top-2 text-orange-500/10 text-4xl group-hover:text-orange-500/20 transition">
                    <i class="fa-brands fa-bitcoin"></i>
                </div>
                <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Bitcoin (BTC)</p>
                <h2 id="btcDisplay" class="text-2xl font-bold text-orange-400 font-mono">0.00000000</h2>
                <p id="btcValueDisplay" class="text-xs text-slate-400 font-mono mt-1">â‰ˆ $0.00</p>
                <div class="text-xs text-slate-500 mt-2 flex justify-between border-t border-slate-700/50 pt-2">
                    <span>Ort. Maliyet:</span>
                    <span id="avgCostDisplay" class="text-slate-300">$0.00</span>
                </div>
            </div>

            <!-- Live Price -->
            <div class="glass-panel p-5 border-l-2 border-yellow-500 bg-gradient-to-r from-yellow-500/5 to-transparent">
                <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">BTC / USD</p>
                <!-- ETÄ°KET GÃœNCELLENDÄ° -->
                <h2 id="priceDisplay" class="text-2xl font-bold text-white">YÃ¼kleniyor...</h2>
                <div class="text-xs mt-2 flex items-center gap-1">
                    <i class="fa-solid fa-bolt text-yellow-500"></i>
                    <span class="text-slate-400">CanlÄ±</span>
                </div>
            </div>
        </div>

        <!-- Main Workspace -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 relative">

            <!-- Left Column: Controls (4 Cols) -->
            <div class="lg:col-span-4 space-y-4 lg:sticky lg:top-24 h-fit">

                <!-- AI Strategy Control -->
                <div class="glass-panel p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-microchip text-indigo-400"></i> AI Stratejisi
                        </h3>
                        <span id="riskBadge"
                            class="text-[10px] bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded border border-indigo-500/30">DENGELÄ°
                            MOD</span>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 mb-2 block">Risk & Sermaye Profili</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="realBot.setRisk('low')" id="riskLow"
                                    class="py-2 text-xs font-bold rounded bg-slate-800 text-slate-400 border border-slate-700 hover:border-green-500 transition">MUHAFAZAKAR<br><span
                                        class="text-[9px] opacity-70">%5 Sermaye</span></button>
                                <button onclick="realBot.setRisk('med')" id="riskMed"
                                    class="py-2 text-xs font-bold rounded bg-blue-600/20 border border-blue-500 text-blue-400 transition">DENGELÄ°<br><span
                                        class="text-[9px] opacity-70">%25 Sermaye</span></button>
                                <button onclick="realBot.setRisk('high')" id="riskHigh"
                                    class="py-2 text-xs font-bold rounded bg-slate-800 text-slate-400 border border-slate-700 hover:border-red-500 transition">AGRESÄ°F<br><span
                                        class="text-[9px] opacity-70">%50 Sermaye</span></button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-slate-400 mb-1 block">Ä°z SÃ¼ren Stop (%)</label>
                                <div class="relative">
                                    <input type="number" id="trailingStopInput" value="1.5" step="0.1"
                                        onchange="realBot.updateConfig()"
                                        class="w-full bg-slate-900/50 border border-slate-700 rounded p-2 text-right text-sm text-white focus:border-blue-500 outline-none">
                                    <span class="absolute left-2 top-2 text-slate-500 text-xs">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 mb-1 block">RSI AlÄ±m EÅŸiÄŸi</label>
                                <div class="relative">
                                    <input type="number" id="rsiBuyInput" value="30" step="1"
                                        onchange="realBot.updateConfig()"
                                        class="w-full bg-slate-900/50 border border-slate-700 rounded p-2 text-right text-sm text-green-400 focus:border-green-500 outline-none">
                                    <span class="absolute left-2 top-2 text-slate-500 text-xs"><i
                                            class="fa-solid fa-arrow-down"></i></span>
                                </div>
                            </div>
                        </div>

                        <!-- YENÄ°: Oto-SatÄ±ÅŸ KÃ¢r Hedefi -->
                        <div class="pt-2">
                            <label
                                class="text-xs text-slate-400 mb-1 block uppercase font-bold tracking-wider">Oto-SatÄ±ÅŸ
                                KÃ¢r Hedefi (%)</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="number" id="otoSatisInput" value="0" step="0.1"
                                        class="w-full bg-slate-900/50 border border-slate-700 rounded p-2 text-right text-sm text-blue-400 focus:border-blue-500 outline-none">
                                    <span class="absolute left-2 top-2 text-slate-500 text-xs">%</span>
                                </div>
                                <button onclick="realBot.updateConfig()"
                                    class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold transition whitespace-nowrap active:scale-95">KAYDET</button>
                            </div>
                        </div>

                        <div class="pt-2 border-t border-slate-700/50">
                            <div class="flex justify-between items-center text-xs text-slate-400 mb-1">
                                <span>AI Karar Skoru:</span>
                                <span id="aiScore" class="font-bold text-slate-200">Veri ToplanÄ±yor</span>
                            </div>
                            <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                <div id="aiScoreBar" class="h-full bg-slate-500 w-1/2 transition-all duration-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Override -->
                <div class="glass-panel p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-hand-holding-dollar text-green-400"></i> Manuel MÃ¼dahale
                        </h3>
                    </div>

                    <div class="space-y-3">
                        <div class="relative mb-2">
                            <input type="number" id="manualInput" oninput="calculatePreview()" placeholder="Tutar (USD)"
                                class="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg focus:border-blue-500 outline-none">
                            <span class="absolute right-3 top-3 text-slate-500 text-xs">USD</span>
                        </div>
                        <!-- HÄ±zlÄ± Tutar ButonlarÄ± -->
                        <div class="grid grid-cols-4 gap-2 mb-3">
                            <button onclick="quickSetAmount(10)"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-400 py-1.5 rounded text-[10px] border border-slate-700 transition active:scale-95">$10</button>
                            <button onclick="quickSetAmount(20)"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-400 py-1.5 rounded text-[10px] border border-slate-700 transition active:scale-95">$20</button>
                            <button onclick="quickSetAmount(50)"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-400 py-1.5 rounded text-[10px] border border-slate-700 transition active:scale-95">$50</button>
                            <button onclick="quickSetAmount(100)"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-400 py-1.5 rounded text-[10px] border border-slate-700 transition active:scale-95">$100</button>
                            <button onclick="quickSetAmount(250)"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-400 py-1.5 rounded text-[10px] border border-slate-700 transition active:scale-95">$250</button>
                            <button onclick="quickSetAmount(500)"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-400 py-1.5 rounded text-[10px] border border-slate-700 transition active:scale-95">$500</button>
                            <button onclick="quickSetAmount(1000)"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-400 py-1.5 rounded text-[10px] border border-slate-700 transition active:scale-95">$1000</button>
                            <button onclick="quickSetAmount('max')"
                                class="bg-slate-800 hover:bg-slate-700 text-blue-400 font-bold py-1.5 rounded text-[10px] border border-slate-700 transition active:scale-95">MAX</button>
                        </div>
                        <div class="flex justify-between text-xs text-slate-400 px-1">
                            <span>Tahmini: <span id="manualBtcPreview" class="text-white">0.00</span> BTC</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="performManualBuy()"
                                class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg transition active:scale-95 shadow-lg shadow-green-900/20">
                                AL (BUY)
                            </button>
                            <button onclick="performManualSell()"
                                class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg transition active:scale-95 shadow-lg shadow-red-900/20">
                                SAT (SELL)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="glass-panel p-0 overflow-hidden flex flex-col h-64">
                    <div
                        class="p-3 bg-slate-900 border-b border-slate-700 flex justify-between items-center sticky top-0 z-10">
                        <span class="text-xs font-bold text-slate-300 uppercase">CanlÄ± Ä°ÅŸlem KÃ¼tÃ¼ÄŸÃ¼</span>
                        <i class="fa-solid fa-terminal text-slate-500 text-xs"></i>
                    </div>
                    <div id="systemLogs" class="p-3 overflow-y-auto font-mono text-xs space-y-2 flex-1 scroll-smooth">
                        <!-- Logs go here -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Chart & Table (8 Cols) -->
            <div class="lg:col-span-8 space-y-6">

                <!-- Chart Container -->
                <div class="glass-panel p-4 h-[450px] flex flex-col">
                    <div
                        class="flex justify-between items-center mb-2 px-2 border-b border-slate-700 pb-2 flex-wrap gap-2">
                        <div class="flex gap-4 items-center">
                            <span class="text-xs font-bold text-slate-300">BTC/USD</span> <!-- BAÅžLIK GÃœNCELLENDÄ° -->
                        </div>
                        <!-- TimeFrame SeÃ§enekleri -->
                        <div class="flex bg-slate-800 rounded p-0.5 gap-0.5 overflow-x-auto" id="timeframeContainer">
                            <button onclick="chartManager.setPeriod('live')"
                                class="px-2 py-1 text-[10px] font-bold rounded transition tf-btn-active"
                                id="tf-live">CANLI</button>
                            <!-- Yeni Eklenenler -->
                            <button onclick="chartManager.setPeriod('5DK')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-5DK">5DK</button>
                            <button onclick="chartManager.setPeriod('15DK')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-15DK">15DK</button>
                            <button onclick="chartManager.setPeriod('30DK')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-30DK">30DK</button>

                            <button onclick="chartManager.setPeriod('1S')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-1S">1S</button>
                            <button onclick="chartManager.setPeriod('6S')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-6S">6S</button>
                            <button onclick="chartManager.setPeriod('12S')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-12S">12S</button>
                            <button onclick="chartManager.setPeriod('1G')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-1G">1G</button>
                            <button onclick="chartManager.setPeriod('1H')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-1H">1H</button>
                            <button onclick="chartManager.setPeriod('1A')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-1A">1A</button>
                            <button onclick="chartManager.setPeriod('6A')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-6A">6A</button>
                            <button onclick="chartManager.setPeriod('1Y')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-1Y">1Y</button>
                            <button onclick="chartManager.setPeriod('5Y')"
                                class="px-2 py-1 text-[10px] font-bold rounded text-slate-400 hover:bg-slate-700 transition"
                                id="tf-5Y">5Y</button>
                        </div>
                    </div>
                    <div
                        class="relative flex-1 w-full overflow-hidden rounded-lg bg-gradient-to-b from-slate-900/50 to-slate-900/10 border border-slate-800">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="glass-panel p-5 flex flex-col max-h-[400px]">
                    <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wide flex-none">Ä°ÅŸlem GeÃ§miÅŸi
                        (Komisyon: %0.1)</h3>
                    <div class="overflow-x-auto overflow-y-auto flex-1 custom-scrollbar relative">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="sticky top-0 bg-slate-900 z-10 shadow-lg">
                                <tr class="text-slate-500 border-b border-slate-700/50">
                                    <th class="pb-3 pl-2 font-medium">Zaman</th>
                                    <th class="pb-3 font-medium">Ä°ÅŸlem</th>
                                    <th class="pb-3 font-medium">Fiyat</th>
                                    <th class="pb-3 font-medium">Miktar</th>
                                    <th class="pb-3 font-medium">Ä°ÅŸlem TutarÄ±</th>
                                    <th class="pb-3 font-medium">Komisyon</th>
                                    <th class="pb-3 pr-2 font-medium text-right">Net Tutar</th>
                                </tr>
                            </thead>
                            <tbody id="transactionTable" class="text-slate-300">
                                <tr>
                                    <td colspan="7" class="text-center py-6 text-slate-600 italic">Veri bekleniyor...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALT ANALÄ°Z GRAFÄ°KLERÄ° -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
            <!-- 1. VarlÄ±k DaÄŸÄ±lÄ±mÄ± -->
            <div class="glass-panel p-5">
                <h3 class="font-bold text-white mb-4 text-center text-sm uppercase tracking-wide">VarlÄ±k DaÄŸÄ±lÄ±mÄ±</h3>
                <div class="h-48 relative">
                    <canvas id="assetPieChart"></canvas>
                </div>
            </div>

            <!-- 2. KÃ¢r/Zarar Analizi (Ä°ÅŸlem BazlÄ±) -->
            <div class="glass-panel p-5">
                <h3 class="font-bold text-white mb-4 text-center text-sm uppercase tracking-wide">Son Ä°ÅŸlem KÃ¢r/Zarar
                </h3>
                <div class="h-48 relative">
                    <canvas id="pnlBarChart"></canvas>
                </div>
            </div>

            <!-- 3. Sermaye BÃ¼yÃ¼mesi (Equity Curve) -->
            <div class="glass-panel p-5">
                <h3 class="font-bold text-white mb-4 text-center text-sm uppercase tracking-wide">Sermaye BÃ¼yÃ¼mesi
                    (Equity)</h3>
                <div class="h-48 relative">
                    <canvas id="equityLineChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- HABERLER MODALI -->
    <div id="newsModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div
            class="glass-panel w-full max-w-2xl bg-[#0f172a] border border-slate-700 rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh] transform scale-95 transition-transform duration-300">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-globe text-blue-400"></i> KÃ¼resel Piyasa Haberleri (Live)
                </h3>
                <button onclick="toggleNewsModal()"
                    class="text-slate-400 hover:text-white transition w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div id="newsContainer" class="p-0 overflow-y-auto flex-1 custom-scrollbar">
                <!-- Haberler buraya dinamik olarak eklenecek -->
            </div>
            <div
                class="p-3 bg-slate-900/50 border-t border-slate-700 text-[10px] text-slate-500 text-center flex justify-between items-center px-6">
                <span><i class="fa-solid fa-robot mr-1"></i>Haberler NLP (DoÄŸal Dil Ä°ÅŸleme) ile analiz
                    edilmektedir.</span>
                <span class="text-slate-400">Kaynak: CoinTelegraph (RSS)</span>
            </div>
        </div>
    </div>

    <script>
        // --- DÃœNYA SAATLERÄ° (YENÄ°) ---
        function updateWorldClocks() {
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            document.getElementById('clockNY').innerText = new Date().toLocaleTimeString('en-US', { ...options, timeZone: 'America/New_York' });
            document.getElementById('clockJP').innerText = new Date().toLocaleTimeString('en-US', { ...options, timeZone: 'Asia/Tokyo' });
            document.getElementById('clockTR').innerText = new Date().toLocaleTimeString('tr-TR', { ...options, timeZone: 'Europe/Istanbul' });
        }
        setInterval(updateWorldClocks, 1000);
        updateWorldClocks(); // Ä°lk aÃ§Ä±lÄ±ÅŸta hemen Ã§alÄ±ÅŸsÄ±n

        // --- HABERLER MODÃœLÃœ (CANLI RSS) ---
        async function fetchNewsFromRSS() {
            const RSS_URL = 'https://cointelegraph.com/rss';
            const API_URL = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(RSS_URL)}`;

            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (data.status === 'ok') {
                    return data.items.slice(0, 6).map(item => {
                        const text = (item.title + " " + item.description).toLowerCase();
                        let sentiment = 'neutral';
                        const posKeywords = ['rise', 'surge', 'jump', 'gain', 'bull', 'high', 'record', 'approve', 'etf', 'adoption', 'buy', 'win', 'rally', 'positive', 'soar', 'green'];
                        const negKeywords = ['drop', 'fall', 'crash', 'loss', 'bear', 'low', 'ban', 'hack', 'scam', 'lawsuit', 'sec', 'reject', 'sell', 'down', 'negative', 'plunge'];

                        let score = 0;
                        posKeywords.forEach(w => { if (text.includes(w)) score++; });
                        negKeywords.forEach(w => { if (text.includes(w)) score--; });

                        if (score > 0) sentiment = 'positive';
                        if (score < 0) sentiment = 'negative';

                        const cleanDesc = item.description ? item.description.replace(/<[^>]*>?/gm, '').slice(0, 120) + "..." : "";

                        return {
                            title: item.title,
                            desc: cleanDesc,
                            sentiment: sentiment,
                            source: "CoinTelegraph",
                            url: item.link,
                            time: new Date(item.pubDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        };
                    });
                }
            } catch (e) {
                console.error("Haber Ã§ekme hatasÄ±:", e);
                realBot.log("Haber servisine eriÅŸilemedi (API HatasÄ±).", "error");
                return [];
            }
            return [];
        }

        async function toggleNewsModal() {
            const modal = document.getElementById('newsModal');
            const panel = modal.querySelector('div');
            const container = document.getElementById('newsContainer');

            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-48 text-slate-500"><i class="fa-solid fa-circle-notch fa-spin text-2xl mb-3 text-blue-500"></i><span class="text-xs">KÃ¼resel piyasalar taranÄ±yor...</span></div>';

                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    panel.classList.remove('scale-95');
                    panel.classList.add('scale-100');
                }, 10);

                const generatedNews = await fetchNewsFromRSS();

                if (generatedNews.length > 0) {
                    renderNews(generatedNews);
                    let sentimentScore = 0;
                    generatedNews.forEach(n => {
                        if (n.sentiment === 'positive') sentimentScore++;
                        if (n.sentiment === 'negative') sentimentScore--;
                    });
                    realBot.processNews(sentimentScore);
                } else {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">Haber akÄ±ÅŸÄ± alÄ±namadÄ±. LÃ¼tfen daha sonra tekrar deneyin.</div>';
                }

            } else {
                modal.classList.add('opacity-0');
                panel.classList.remove('scale-100');
                panel.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        function renderNews(newsData) {
            const container = document.getElementById('newsContainer');
            container.innerHTML = newsData.map(item => {
                let colorClass = "border-slate-700";
                let icon = '<i class="fa-regular fa-newspaper text-slate-400"></i>';
                let sentimentText = "";

                if (item.sentiment === 'positive') {
                    colorClass = "border-green-900/50 bg-green-900/10";
                    icon = '<i class="fa-solid fa-arrow-trend-up text-green-400"></i>';
                    sentimentText = '<span class="text-[10px] uppercase font-bold text-green-400 ml-2">OLUMLU</span>';
                } else if (item.sentiment === 'negative') {
                    colorClass = "border-red-900/50 bg-red-900/10";
                    icon = '<i class="fa-solid fa-arrow-trend-down text-red-400"></i>';
                    sentimentText = '<span class="text-[10px] uppercase font-bold text-red-400 ml-2">OLUMSUZ</span>';
                }

                return `
                    <div class="p-4 border-b ${colorClass} hover:bg-slate-800/30 transition flex gap-3 group">
                        <div class="mt-1 text-lg">${icon}</div>
                        <div class="flex-1">
                            <a href="${item.url}" target="_blank" class="block">
                                <h4 class="text-sm font-semibold text-slate-200 leading-tight mb-1 group-hover:text-blue-400 transition">
                                    ${item.title} ${sentimentText} <i class="fa-solid fa-external-link-alt text-[10px] ml-1 opacity-0 group-hover:opacity-100 transition"></i>
                                </h4>
                            </a>
                            <p class="text-xs text-slate-400 leading-relaxed">${item.desc}</p>
                            <div class="mt-2 flex items-center gap-2 text-[10px] text-slate-500">
                                <span><i class="fa-regular fa-clock mr-1"></i>${item.time}</span>
                                <span>â€¢</span>
                                <span>Kaynak: ${item.source}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- SES EFEKTLERÄ° ---
        const audioSystem = {
            ctx: null,
            init: function () {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            playProfit: function () {
                if (realBot.muted) return;
                this.init();
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1046.50, now);
                osc.frequency.setValueAtTime(1318.51, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(now); osc.stop(now + 0.3);
            },
            playCoin: function () {
                if (realBot.muted) return;
                this.init();
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1600, now);
                osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0.0, now + 0.1);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(now); osc.stop(now + 0.1);
            },
            playLoss: function () {
                if (realBot.muted) return;
                this.init();
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(200, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(now); osc.stop(now + 0.2);
            }
        };

        // --- GRAFÄ°K YÃ–NETÄ°CÄ°SÄ° ---
        const chartManager = {
            currentPeriod: 'live',

            setPeriod: async function (period) {
                this.currentPeriod = period;
                document.querySelectorAll('#timeframeContainer button').forEach(btn => {
                    btn.classList.remove('tf-btn-active', 'text-white');
                    btn.classList.add('text-slate-400', 'hover:bg-slate-700');
                });
                const activeBtn = document.getElementById(`tf-${period}`);
                activeBtn.classList.remove('text-slate-400', 'hover:bg-slate-700');
                activeBtn.classList.add('tf-btn-active');

                if (period === 'live') {
                    // CANLI Moda DÃ¶nÃ¼ÅŸ: HafÄ±zadaki veriyi geri yÃ¼kle
                    priceChart.data.labels = new Array(realBot.history.length).fill('');
                    priceChart.data.datasets[0].data = [...realBot.history]; // Fiyat geÃ§miÅŸini kopyala
                    priceChart.data.datasets[1].data = [...realBot.ma_history]; // MA geÃ§miÅŸini kopyala

                    // Ä°ÅŸlemleri (Sinyalleri) Geri YÃ¼kle
                    const buys = [];
                    const sells = [];

                    realBot.historyTimes.forEach(time => {
                        let buyVal = null;
                        let sellVal = null;
                        // O anki zamana denk gelen iÅŸlem var mÄ±? (1 saniyelik toleransla)
                        realBot.transactions.forEach(tx => {
                            if (Math.abs(tx.timestamp - time) < 1500) {
                                if (tx.type === 'BUY') buyVal = tx.price;
                                if (tx.type === 'SELL') sellVal = tx.price;
                            }
                        });
                        buys.push(buyVal);
                        sells.push(sellVal);
                    });

                    priceChart.data.datasets[2].data = buys;
                    priceChart.data.datasets[3].data = sells;

                    priceChart.update();
                    realBot.log("Grafik CANLI moda alÄ±ndÄ±.", "info");
                    return;
                }
                await this.fetchHistory(period);
            },

            fetchHistory: async function (period) {
                let interval = '1h';
                let limit = 100;
                switch (period) {
                    case '5DK': interval = '1m'; limit = 5; break;   // Son 5 dakika
                    case '15DK': interval = '1m'; limit = 15; break; // Son 15 dakika
                    case '30DK': interval = '1m'; limit = 30; break; // Son 30 dakika

                    case '1S': interval = '1m'; limit = 60; break;
                    case '6S': interval = '5m'; limit = 72; break;
                    case '12S': interval = '15m'; limit = 48; break;
                    case '1G': interval = '15m'; limit = 96; break;
                    case '1H': interval = '1h'; limit = 168; break;
                    case '1A': interval = '4h'; limit = 180; break;
                    case '6A': interval = '1d'; limit = 180; break;
                    case '1Y': interval = '1d'; limit = 365; break;
                    case '5Y': interval = '1w'; limit = 260; break;
                }

                try {
                    const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${interval}&limit=${limit}`);
                    const data = await response.json();
                    const closes = data.map(d => parseFloat(d[4]));
                    const labels = data.map(d => {
                        const date = new Date(d[0]);
                        return period.includes('S') || period === '1G' ? date.toLocaleTimeString() : date.toLocaleDateString();
                    });

                    priceChart.data.labels = labels;
                    priceChart.data.datasets[0].data = closes;

                    // MA Hesapla
                    const ma = [];
                    const maPeriod = 20;
                    for (let i = 0; i < closes.length; i++) {
                        if (i < maPeriod) { ma.push(null); } else {
                            const slice = closes.slice(i - maPeriod, i);
                            const avg = slice.reduce((a, b) => a + b, 0) / maPeriod;
                            ma.push(avg);
                        }
                    }
                    priceChart.data.datasets[1].data = ma;

                    // --- Ä°ÅžLEM EÅžLEÅžTÄ°RME (Sinyalleri Sabitleme) ---
                    const buySignals = new Array(closes.length).fill(null);
                    const sellSignals = new Array(closes.length).fill(null);

                    // Her mum Ã§ubuÄŸu iÃ§in kontrol et
                    data.forEach((candle, index) => {
                        const openTime = candle[0]; // Mum aÃ§Ä±lÄ±ÅŸ zamanÄ± (ms)
                        const closeTime = candle[6]; // Mum kapanÄ±ÅŸ zamanÄ± (ms)

                        // Bu mumun sÃ¼resi iÃ§inde yapÄ±lmÄ±ÅŸ bir iÅŸlem var mÄ±?
                        realBot.transactions.forEach(tx => {
                            if (tx.timestamp >= openTime && tx.timestamp <= closeTime) {
                                if (tx.type === 'BUY') buySignals[index] = tx.price; // Ä°ÅŸlem fiyatÄ±nÄ± o muma iÅŸaretle
                                if (tx.type === 'SELL') sellSignals[index] = tx.price;
                            }
                        });
                    });

                    priceChart.data.datasets[2].data = buySignals;
                    priceChart.data.datasets[3].data = sellSignals;
                    // ------------------------------------------------

                    priceChart.update();
                    realBot.log(`${period} geÃ§miÅŸ verisi yÃ¼klendi ve iÅŸlemler iÅŸlendi.`, "success");

                } catch (e) {
                    realBot.log("GeÃ§miÅŸ veri Ã§ekilemedi.", "error");
                    console.error(e);
                }
            }
        };


        // --- REAL TRADING ENGINE (Binance API) ---

        const realBot = {
            budget: 1000.0,      // SABÄ°T BAÅžLANGIÃ‡ SERMAYESÄ°
            btc_amount: 0.0,
            initial_balance: 1000.0,
            secured_profit: 0.0, // GÃ¼venli Kasa
            pending_profit: 0.0,
            invested_capital: 0.0,
            aktif_pozisyonlar: [], // YENÄ°: AlÄ±nan her lotun maliyet ve miktar takibi
            oto_satis_hedefi: 0,   // YENÄ°: KullanÄ±cÄ±nÄ±n belirlediÄŸi % kÃ¢r hedefi

            current_price: 0.0,
            try_rate: 36.50, // VarsayÄ±lan TRY Kuru (API'den gÃ¼ncellenecek)
            lastTryUpdate: 0,

            history: [],
            historyTimes: [],
            ma_history: [],

            is_running: false,
            is_analyzing: false,
            market_bias: "NEUTRAL", // YENÄ°: BULL, BEAR, NEUTRAL
            ai_confidence: 0, // YENÄ°: 0-100 arasÄ± gÃ¼ven skoru
            first_trade_done: false,
            muted: false,
            avg_buy_price: 0.0,
            peak_price: 0.0,
            lastAutoTrade: 0,
            lastAction: null,

            transactions: [],
            logs: [],

            config: {
                riskLevel: 'med',
                minProfitUsd: 10.0, // HEDEF: Ä°ÅŸlem baÅŸÄ±na en az 10$ Net KÃ¢r
                commissionRate: 0.001, // Binance Spot Komisyonu (%0.1)
                trailingStopPercent: 1.5,
                rsiBuyThreshold: 30,
                tradeAmountPercent: 100
            },

            // ... (processNews fonksiyonu aynÄ± kalÄ±yor) ...
            processNews: function (score) {
                const aiBadge = document.getElementById('aiScore');
                const aiBar = document.getElementById('aiScoreBar');

                let sentiment = "NÃ–TR";
                let colorClass = "text-slate-200";

                if (score >= 2) {
                    sentiment = "POZÄ°TÄ°F (BOÄžA)";
                    colorClass = "text-green-400 neon-text";
                    aiBar.style.width = "90%"; aiBar.className = "h-full bg-green-500 transition-all duration-500";
                    this.log(`ðŸ”¥ HABER ETKÄ°SÄ°: GÃ¼Ã§lÃ¼ olumlu hava (${score}).`, "success");
                    // Haber etkisiyle de olsa sadece bakiye uygunsa alÄ±r
                    if (this.budget >= 999 && this.btc_amount === 0) {
                        this.buy(this.budget, 1000, "Haber KaynaklÄ± AI AlÄ±mÄ±");
                    }
                } else if (score <= -2) {
                    sentiment = "NEGATÄ°F (AYI)";
                    colorClass = "text-red-400 neon-red";
                    aiBar.style.width = "10%"; aiBar.className = "h-full bg-red-500 transition-all duration-500";
                    this.log(`âš ï¸ HABER ETKÄ°SÄ°: Olumsuz hava (${score}). Beklemeye devam.`, "warning");
                } else {
                    aiBar.style.width = "50%"; aiBar.className = "h-full bg-slate-500 transition-all duration-500";
                    this.log(`â„¹ï¸ HABER ETKÄ°SÄ°: Piyasa dengeli (${score}).`, "warning");
                }

                aiBadge.innerText = sentiment;
                aiBadge.className = `font-bold ${colorClass}`;
            },

            // YENÄ°: 1 AylÄ±k GeÃ§miÅŸ Veri Analizi
            performInitialAnalysis: async function () {
                this.is_analyzing = true;
                this.log("â³ AI: 1 AylÄ±k makro trend analiz ediliyor...", "warning");

                try {
                    const response = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=4h&limit=180');
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const prices = data.map(d => parseFloat(d[4]));
                        const oldestPrice = prices[0];
                        const latestPrice = prices[prices.length - 1];

                        // Market Bias Hesapla
                        const priceChange = ((latestPrice - oldestPrice) / oldestPrice) * 100;
                        if (priceChange > 2) this.market_bias = "BULL";
                        else if (priceChange < -2) this.market_bias = "BEAR";
                        else this.market_bias = "NEUTRAL";

                        this.log(`âœ… AI Analizi: ${this.market_bias} Market (Varyasyon: %${priceChange.toFixed(1)})`, "success");
                        this.log(`ðŸš€ AI Taktik: ${this.market_bias === "BULL" ? "Agresif GiriÅŸ" : "SeÃ§ici GiriÅŸ"} aktif.`, "system");
                    }
                } catch (e) {
                    this.log("âš ï¸ Analiz hatasÄ±, nÃ¶tr modda devam ediliyor.", "error");
                    this.market_bias = "NEUTRAL";
                } finally {
                    this.is_analyzing = false;
                }
            },
            fetchTryRate: async function () {
                const now = Date.now();
                // Her 60 saniyede bir kuru gÃ¼ncelle (API limitini korumak iÃ§in)
                if (now - this.lastTryUpdate < 60000) return;

                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTTRY');
                    const data = await response.json();
                    if (data && data.price) {
                        this.try_rate = parseFloat(data.price);
                        this.lastTryUpdate = now;
                    }
                } catch (e) {
                    console.log("TRY kuru gÃ¼ncellenemedi, varsayÄ±lan deÄŸer kullanÄ±lÄ±yor.");
                }
            },

            fetchPrice: async function () {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                    const data = await response.json();
                    return parseFloat(data.price);
                } catch (error) {
                    return null;
                }
            },

            tick: async function () {
                const price = await this.fetchPrice();

                // TRY Kurunu gÃ¼ncelle (Periyodik)
                this.fetchTryRate();

                if (!price) return;

                this.current_price = price;
                this.history.push(this.current_price);
                this.historyTimes.push(Date.now());

                if (this.history.length > 50) {
                    this.history.shift();
                    this.historyTimes.shift();
                }

                const maPeriod = 20;
                let ma = null;
                if (this.history.length >= maPeriod) {
                    const slice = this.history.slice(-maPeriod);
                    const sum = slice.reduce((a, b) => a + b, 0);
                    ma = sum / maPeriod;
                    this.ma_history.push(ma);
                } else {
                    this.ma_history.push(this.current_price);
                }
                if (this.ma_history.length > 50) this.ma_history.shift();

                const rsi = this.calculateRSI();

                let isTrendUp = false;
                if (this.history.length > 5) {
                    isTrendUp = this.history[this.history.length - 1] > this.history[this.history.length - 5];
                }

                // ARTIK checkProfitSkim() BURADA Ã‡ALIÅžMIYOR.
                // KÃ¢r transferi sadece iÅŸlem kapandÄ±ÄŸÄ±nda (sellAll iÃ§inde) yapÄ±lacak.
                this.updateFloatingProfitStatus();

                // YENÄ°: LOT BAZLI OTOMATÄ°K SATIÅž KONTROLÃœ
                if (this.is_running && this.oto_satis_hedefi > 0 && this.aktif_pozisyonlar.length > 0) {
                    this.checkLotProfitLevels();
                }

                if (this.is_running && !this.is_analyzing && rsi !== null) {
                    this.evaluateStrategy(rsi);
                }

                updateUI(rsi, isTrendUp);
            },

            // Her bir lotun kÃ¢r durumunu kontrol eder
            checkLotProfitLevels: function () {
                const results = [];
                for (let i = this.aktif_pozisyonlar.length - 1; i >= 0; i--) {
                    const lot = this.aktif_pozisyonlar[i];
                    const profitPercent = ((this.current_price - lot.maliyet) / lot.maliyet) * 100;

                    if (profitPercent >= this.oto_satis_hedefi) {
                        this.log(`ðŸŽ¯ LOT HEDEFÄ°NE ULAÅžILDI: %${profitPercent.toFixed(2)} kÃ¢r ile satÄ±ÅŸ yapÄ±lÄ±yor.`, "success");
                        this.sellSpecificLot(i, profitPercent);
                    }
                }
            },

            sellSpecificLot: function (index, profitPercent) {
                const lot = this.aktif_pozisyonlar[index];
                const grossUsd = lot.miktar * this.current_price;
                const fee = grossUsd * this.config.commissionRate;
                const netUsd = grossUsd - fee;
                const profitUsd = netUsd - (lot.maliyet * lot.miktar);

                this.budget += netUsd;
                this.btc_amount -= lot.miktar;

                // Ä°ÅŸlem geÃ§miÅŸine ekle
                this.addTransaction("SELL", this.current_price, grossUsd, fee, netUsd, lot.miktar, profitUsd);
                this.log(`ðŸ’° OTO-SATIÅž: $${netUsd.toFixed(2)} (KÃ¢r: %${profitPercent.toFixed(2)})`, "success");

                audioSystem.playProfit();

                // Pozisyonu diziden Ã§Ä±kar
                this.aktif_pozisyonlar.splice(index, 1);

                // Kasa Transferi (Opsiyonel: EÄŸer bakiye 1000$ Ã¼stÃ¼ndeyse)
                if (this.budget > 1000) {
                    const excess = this.budget - 1000;
                    this.secured_profit += excess;
                    this.budget = 1000;
                    this.log(`ðŸ”’ KASA: $${excess.toFixed(2)} kÃ¢r kasaya aktarÄ±ldÄ±.`, "success");
                }
            },

            // Sadece UI gÃ¼ncellemesi iÃ§in bekleyen kÃ¢rÄ± hesaplar (Ä°ÅŸlem yapmaz)
            updateFloatingProfitStatus: function () {
                if (this.btc_amount > 0) {
                    const currentVal = this.btc_amount * this.current_price;
                    const estimatedFee = currentVal * this.config.commissionRate;
                    const netVal = currentVal - estimatedFee;
                    const profit = netVal - this.invested_capital;
                    this.pending_profit = profit;
                } else {
                    this.pending_profit = 0;
                }
            },

            // ... (toggle, toggleSound, setRisk, updateConfig, calculateRSI aynÄ±) ...
            toggle: function () {
                audioSystem.init();
                this.is_running = !this.is_running;
                const btn = document.getElementById('mainToggleBtn');
                if (this.is_running) {
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                    btn.classList.add('bg-red-600', 'hover:bg-red-500');
                    btn.innerHTML = '<i class="fa-solid fa-stop"></i> DURDUR';
                    this.log("AI Motoru BaÅŸlatÄ±ldÄ±.", "system");

                    // Ä°ÅŸlem yoksa ve ilk iÅŸlem yapÄ±lmadÄ±ysa analizi baÅŸlat
                    if (this.btc_amount === 0 && !this.first_trade_done) {
                        this.performInitialAnalysis();
                    }
                } else {
                    btn.classList.remove('bg-red-600', 'hover:bg-red-500');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                    btn.innerHTML = '<i class="fa-solid fa-power-off"></i> BAÅžLAT';
                    this.log("AI Motoru Durduruldu.", "warning");
                }
            },
            toggleSound: function () {
                this.muted = !this.muted;
                const btn = document.getElementById('soundToggleBtn');
                const icon = btn.querySelector('i');
                if (this.muted) {
                    icon.classList.remove('fa-volume-high'); icon.classList.add('fa-volume-xmark');
                    btn.classList.add('text-red-400'); btn.classList.remove('text-green-400');
                    this.log("Sesler KapatÄ±ldÄ±.", "info");
                } else {
                    icon.classList.remove('fa-volume-xmark'); icon.classList.add('fa-volume-high');
                    btn.classList.add('text-green-400'); btn.classList.remove('text-red-400');
                    this.log("Sesler AÃ§Ä±ldÄ±.", "info");
                    audioSystem.init();
                }
            },
            setRisk: function (level) {
                // Bu stratejide risk profili sabit, ancak UI'yÄ± bozmamak iÃ§in butonlarÄ± gÃ¼ncelliyoruz
                ['riskLow', 'riskMed', 'riskHigh'].forEach(id => {
                    const el = document.getElementById(id);
                    el.classList.remove('bg-blue-600/20', 'border-blue-500', 'text-blue-400');
                    el.classList.add('bg-slate-800', 'border-slate-700', 'text-slate-400');
                });
                const activeBtn = document.getElementById('risk' + level.charAt(0).toUpperCase() + level.slice(1));
                activeBtn.classList.remove('bg-slate-800', 'border-slate-700', 'text-slate-400');
                activeBtn.classList.add('bg-blue-600/20', 'border-blue-500', 'text-blue-400');

                const badge = document.getElementById('riskBadge');
                badge.innerText = "SABÄ°T $10 HEDEFÄ°";
                badge.className = "text-[10px] bg-green-500/20 text-green-300 px-2 py-1 rounded border border-green-500/30";

                this.log(`Mod gÃ¼ncellendi: Sabit $10 KÃ¢r Stratejisi Aktif.`, "info");
            },
            updateConfig: function () {
                this.config.rsiBuyThreshold = parseFloat(document.getElementById('rsiBuyInput').value) || 30;
                // Yeni oto-satÄ±ÅŸ hedefini kaydet
                const target = parseFloat(document.getElementById('otoSatisInput').value) || 0;
                this.oto_satis_hedefi = target;
                if (target > 0) {
                    this.log(`âš™ï¸ Oto-SatÄ±ÅŸ Hedefi %${target} olarak gÃ¼ncellendi.`, "info");
                }
            },
            calculateRSI: function () {
                if (this.history.length < 15) return 50;
                let gains = 0; let losses = 0;
                for (let i = 1; i < 14; i++) {
                    const change = this.history[this.history.length - i] - this.history[this.history.length - i - 1];
                    if (change > 0) gains += change; else losses += Math.abs(change);
                }
                if (losses === 0) return 100;
                const rs = gains / losses;
                return 100 - (100 / (1 + rs));
            },

            // --- STRATEJÄ° MOTORU (GÃœNCELLENDÄ°) ---
            evaluateStrategy: function (rsi) {
                const now = Date.now();
                if (now - this.lastAutoTrade < 5000) return;

                // 1. SATIÅž MANTIÄžI: SADECE +10$ NET KÃ‚R VARSA
                if (this.btc_amount > 0) {
                    const currentVal = this.btc_amount * this.current_price;
                    const estimatedFee = currentVal * this.config.commissionRate;
                    const netProceeds = currentVal - estimatedFee;
                    const netProfit = netProceeds - this.invested_capital; // Net KÃ¢r HesabÄ±

                    // KRÄ°TÄ°K KURAL: Net kÃ¢r 10$ veya Ã¼zerindeyse SAT
                    if (netProfit >= this.config.minProfitUsd) {
                        // AI Momentum KontrolÃ¼: Ä°vme hala gÃ¼Ã§lÃ¼yse biraz daha bekle (KÃ¢r maksimizasyonu)
                        const isMomentumUp = this.current_price > this.ma_history[this.ma_history.length - 1];
                        if (isMomentumUp && netProfit < this.config.minProfitUsd + 5) {
                            this.log(`ðŸ“ˆ Momentum GÃ¼Ã§lÃ¼: KÃ¢r maksimizasyonu iÃ§in bekleniyor (+$${netProfit.toFixed(2)})`, "warning");
                            return;
                        }
                        this.sellAll(`AI HEDEF ONAYI (+$${netProfit.toFixed(2)})`);
                        this.lastAutoTrade = now;
                    }
                    return;
                }

                // 2. AI ALIM MANTIÄžI (SIGNAL CONFIRMATION)
                if (this.budget >= 100) {
                    let score = 0;
                    const currentMA = this.ma_history[this.ma_history.length - 1];
                    const dynamicRsiThreshold = this.market_bias === "BULL" ? 35 : (this.market_bias === "BEAR" ? 25 : 30);

                    if (rsi < dynamicRsiThreshold) score += 40; // RSI OnayÄ±
                    if (this.current_price > currentMA) score += 30; // Momentum OnayÄ±
                    if (this.market_bias === "BULL") score += 30; // Makro Trend OnayÄ±
                    else if (this.market_bias === "NEUTRAL") score += 15;

                    this.ai_confidence = score;

                    // AI KARAR EÅžÄ°ÄžÄ°: %70 GÃ¼ven gerektirir
                    if (score >= 70) {
                        const targetAmount = !this.first_trade_done ? 100 : 1000;
                        if (this.budget >= targetAmount) {
                            this.log(`ðŸ¤– AI OnayÄ± AlÄ±ndÄ±: GÃ¼ven %${score} | GiriÅŸ YapÄ±lÄ±yor.`, "success");
                            this.buy(targetAmount, targetAmount, `AI OnaylÄ± GiriÅŸ (Skor %${score})`);
                            this.lastAutoTrade = now;
                        }
                    }
                }
            },

            buy: function (usdAmount, fixedCapital, reason) {
                // Bakiyeye gÃ¶re gÃ¼venli tutar belirle
                if (usdAmount > this.budget) usdAmount = this.budget;
                if (usdAmount < 10) return;

                const fee = usdAmount * this.config.commissionRate;
                const netAmount = usdAmount - fee;
                const btc = netAmount / this.current_price;

                this.invested_capital = usdAmount;
                const totalValueBefore = this.btc_amount * this.avg_buy_price;
                const newValue = netAmount;
                const totalBTC = this.btc_amount + btc;
                this.avg_buy_price = (totalValueBefore + newValue) / totalBTC;

                this.budget -= usdAmount;
                this.btc_amount += btc;
                this.first_trade_done = true;

                // YENÄ°: Lot Takibi
                this.aktif_pozisyonlar.push({
                    maliyet: this.current_price,
                    miktar: btc,
                    zaman: Date.now()
                });

                this.peak_price = this.current_price;
                this.addTransaction("BUY", this.current_price, usdAmount, fee, netAmount, btc);
                this.log(`ALIM: $${usdAmount.toFixed(2)} | ${reason}`, "success");
            },

            // sellPartial ARTIK KULLANILMIYOR (Tek parÃ§a iÅŸlem kuralÄ±)
            sellPartial: function (usdAmount, reason) { /* Devre dÄ±ÅŸÄ± */ },

            sellAll: function (reason) {
                if (this.btc_amount <= 0) return;

                const grossUsd = this.btc_amount * this.current_price;
                const fee = grossUsd * this.config.commissionRate;
                const netUsd = grossUsd - fee;

                // GerÃ§ek Net KÃ¢r (Komisyonlar dÃ¼ÅŸÃ¼ldÃ¼)
                const profit = netUsd - this.invested_capital;
                const isProfit = profit > 0;

                this.budget += netUsd;
                this.addTransaction("SELL", this.current_price, grossUsd, fee, netUsd, this.btc_amount, profit);

                const emoji = isProfit ? "ðŸ¤‘" : "ðŸ›‘";
                const type = isProfit ? "success" : "error";
                this.log(`${emoji} SATIÅž: $${netUsd.toFixed(2)} (Net: +$${profit.toFixed(2)}) | ${reason}`, type);

                if (isProfit) audioSystem.playProfit(); else audioSystem.playLoss();

                this.btc_amount = 0;
                this.avg_buy_price = 0;
                this.peak_price = 0;
                this.invested_capital = 0; // YatÄ±rÄ±m sÄ±fÄ±rlandÄ±

                // --- KÃ‚R YÃ–NETÄ°MÄ° (PROFIT MANAGEMENT) ---
                // EÄŸer satÄ±ÅŸ sonrasÄ± bakiye 1000 USD'den fazlaysa, fazlasÄ±nÄ± kasaya at
                if (this.budget > 1000) {
                    const excess = this.budget - 1000;

                    // Sadece 1000$ sermaye bÄ±rak, gerisini al
                    this.secured_profit += excess;
                    this.budget = 1000;

                    this.log(`ðŸ”’ KASA TRANSFERÄ°: $${excess.toFixed(2)} gÃ¼venli kasaya aktarÄ±ldÄ±.`, "success");
                    this.log(`ðŸ”„ Sermaye $1000 olarak sÄ±fÄ±rlandÄ±.`, "system");

                    // Kasa animasyonu
                    const card = document.getElementById('safeWalletCard');
                    card.classList.add('profit-animate');
                    setTimeout(() => card.classList.remove('profit-animate'), 1000);
                }
            },

            addTransaction: function (type, price, gross, fee, net, amount, pnl = 0) {
                // UI Sinyali iÃ§in
                this.lastAction = { type: type, price: price };

                const tx = {
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString(),
                    type: type, price: price, gross: gross, fee: fee, net: net, amount: amount, pnl: pnl
                };
                this.transactions.unshift(tx);
                if (this.transactions.length > 50) this.transactions.pop();
                if (type === "SELL") { updatePnlChart(pnl); }
            },

            log: function (msg, type) {
                this.logs.unshift({ time: new Date().toLocaleTimeString(), msg: msg, type: type });
                if (this.logs.length > 50) this.logs.pop();
            },

            reset: function () {
                this.budget = 1000;
                this.btc_amount = 0;
                this.avg_buy_price = 0;
                this.invested_capital = 0;
                this.transactions = [];
                this.logs = [];
                this.history = [];
                this.historyTimes = [];
                this.lastAction = null;
                this.secured_profit = 0;
                this.log("Sistem sÄ±fÄ±rlandÄ±. Sermaye: $1000", "system");
                pnlBarChart.data.labels = []; pnlBarChart.data.datasets[0].data = []; pnlBarChart.update();
                equityLineChart.data.labels = []; equityLineChart.data.datasets[0].data = []; equityLineChart.update();
            }
        };

        // ... (Kalan kodlar aynÄ±)
        // HÄ±zlÄ± Tutar SeÃ§imi
        function quickSetAmount(val) {
            const input = document.getElementById('manualInput');
            if (val === 'max') {
                input.value = realBot.budget.toFixed(2);
            } else {
                input.value = val;
            }
            calculatePreview();
        }

        function calculatePreview() {
            const usd = parseFloat(document.getElementById('manualInput').value);
            if (usd > 0 && realBot.current_price > 0) {
                const fee = usd * 0.001;
                const net = usd - fee;
                const btc = net / realBot.current_price;
                document.getElementById('manualBtcPreview').innerText = btc.toFixed(6);
            } else {
                document.getElementById('manualBtcPreview').innerText = "0.00";
            }
        }
        function performManualBuy() {
            const usd = parseFloat(document.getElementById('manualInput').value);
            if (usd > 0 && usd <= realBot.budget) {
                realBot.buy(usd, 1000, "KullanÄ±cÄ± Manuel AlÄ±mÄ±");
                document.getElementById('manualInput').value = "";
                calculatePreview();
            } else { alert("GeÃ§ersiz bakiye veya miktar."); }
        }
        function performManualSell() { realBot.sellAll("KullanÄ±cÄ± Manuel SatÄ±ÅŸÄ±"); }

        // YENÄ°: Holding kartÄ±na tÄ±klanÄ±nca bakiyeyi inputa doldur
        function fillManualInputWithBalance() {
            if (realBot.btc_amount > 0 && realBot.current_price > 0) {
                const totalValue = realBot.btc_amount * realBot.current_price;
                const inputEl = document.getElementById('manualInput');
                inputEl.value = totalValue.toFixed(2);

                // Input alanÄ±nÄ± vurgula (GÃ¶rsel geribildirim)
                const originalBg = inputEl.style.backgroundColor;
                inputEl.style.backgroundColor = 'rgba(59, 130, 246, 0.2)'; // Blue tint
                inputEl.style.borderColor = '#3b82f6';

                setTimeout(() => {
                    inputEl.style.backgroundColor = originalBg;
                    inputEl.style.borderColor = ''; // Reset border
                }, 300);

                calculatePreview();
            }
        }

        // --- GRAFÄ°KLER ---
        const ctx = document.getElementById('priceChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
        gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

        const priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(50).fill(''),
                datasets: [
                    { label: 'Fiyat', data: [], borderColor: '#3b82f6', backgroundColor: gradient, borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0, order: 1 },
                    { label: 'MA(20)', data: [], borderColor: '#a855f7', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false, tension: 0.4, order: 0 },
                    // YENÄ° KATMANLAR: ALIM ve SATIM SÄ°NYALLERÄ°
                    {
                        label: 'AlÄ±m Sinyali',
                        data: [], // Paralel veri dizisi
                        type: 'scatter',
                        pointStyle: 'triangle',
                        pointRadius: 8,
                        backgroundColor: '#22c55e', // Green
                        borderColor: '#22c55e',
                        borderWidth: 1,
                        order: 2
                    },
                    {
                        label: 'SatÄ±m Sinyali',
                        data: [],
                        type: 'scatter',
                        pointStyle: 'triangle',
                        pointRadius: 8,
                        pointRotation: 180, // Ters Ã¼Ã§gen
                        backgroundColor: '#ef4444', // Red
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: true, position: 'right', grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b', font: { size: 10 } } } },
                animation: false, interaction: { intersect: false, mode: 'index' }
            }
        });

        // ... (DiÄŸer grafikler: pie, pnl, equity aynÄ±)
        // 1. PASTA GRAFÄ°ÄžÄ° (VarlÄ±k DaÄŸÄ±lÄ±mÄ±)
        const pieCtx = document.getElementById('assetPieChart').getContext('2d');
        const assetPieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['Nakit (USDT)', 'Bitcoin (BTC)'],
                datasets: [{ data: [1000, 0], backgroundColor: ['#22c55e', '#f97316'], borderColor: '#0f172a', borderWidth: 2, hoverOffset: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } }, cutout: '60%' }
        });

        // 2. Ã‡UBUK GRAFÄ°K (KÃ¢r/Zarar)
        const pnlCtx = document.getElementById('pnlBarChart').getContext('2d');
        const pnlBarChart = new Chart(pnlCtx, {
            type: 'bar',
            data: {
                labels: [], // Ä°ÅŸlem ID'leri
                datasets: [{
                    label: 'PNL ($)',
                    data: [],
                    backgroundColor: function (context) {
                        const value = context.dataset.data[context.dataIndex];
                        return value >= 0 ? '#22c55e' : '#ef4444';
                    },
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b', font: { size: 10 } } }
                }
            }
        });

        function updatePnlChart(amount) {
            const count = pnlBarChart.data.labels.length + 1;
            pnlBarChart.data.labels.push(count);
            pnlBarChart.data.datasets[0].data.push(amount);
            if (pnlBarChart.data.labels.length > 20) {
                pnlBarChart.data.labels.shift();
                pnlBarChart.data.datasets[0].data.shift();
            }
            pnlBarChart.update();
        }

        // 3. Ã‡Ä°ZGÄ° GRAFÄ°K (Equity Curve - Sermaye BÃ¼yÃ¼mesi)
        const equityCtx = document.getElementById('equityLineChart').getContext('2d');
        const eqGradient = equityCtx.createLinearGradient(0, 0, 0, 200);
        eqGradient.addColorStop(0, 'rgba(234, 179, 8, 0.2)'); // Yellow-500
        eqGradient.addColorStop(1, 'rgba(234, 179, 8, 0)');

        const equityLineChart = new Chart(equityCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Toplam VarlÄ±k ($)',
                    data: [],
                    borderColor: '#eab308', // Yellow-500
                    backgroundColor: eqGradient,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b', font: { size: 10 } } }
                },
                animation: false
            }
        });

        // --- UI UPDATE LOOP ---
        function updateUI(rsi, isTrendUp) {
            if (realBot.current_price === 0) return;

            // ... (Metin gÃ¼ncellemeleri)
            document.getElementById('priceDisplay').innerText = `$${realBot.current_price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const rsiEl = document.getElementById('rsiIndicator');
            rsiEl.innerText = rsi ? rsi.toFixed(1) : "--.-";
            if (rsi > 70) rsiEl.className = "font-bold text-red-400 font-mono neon-red";
            else if (rsi < 30) rsiEl.className = "font-bold text-green-400 font-mono neon-text";
            else rsiEl.className = "font-bold text-blue-400 font-mono";

            const trendEl = document.getElementById('trendIndicator');
            if (isTrendUp) trendEl.innerHTML = '<i class="fa-solid fa-arrow-trend-up mr-1"></i>YÃœKSELÄ°Åž';
            else trendEl.innerHTML = '<i class="fa-solid fa-arrow-trend-down mr-1 text-red-500"></i>DÃœÅžÃœÅž';
            trendEl.className = isTrendUp ? "font-bold text-green-400" : "font-bold text-red-400";

            const totalVal = realBot.budget + (realBot.btc_amount * realBot.current_price);
            document.getElementById('portfolioDisplay').innerText = `$${totalVal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('budgetDisplay').innerText = `$${realBot.budget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('btcDisplay').innerText = realBot.btc_amount.toFixed(8);

            // YENÄ°: Bitcoin Dolar KarÅŸÄ±lÄ±ÄŸÄ± GÃ¼ncellemesi
            const btcVal = realBot.btc_amount * realBot.current_price;
            document.getElementById('btcValueDisplay').innerText = `â‰ˆ $${btcVal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            // YENÄ°: Kasa ve Bekleyen KÃ¢r GÃ¼ncellemesi
            document.getElementById('securedProfitDisplay').innerText = `$${realBot.secured_profit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            // TL KarÅŸÄ±lÄ±ÄŸÄ±nÄ± Hesapla ve GÃ¶ster
            const securedTry = realBot.secured_profit * realBot.try_rate;
            document.getElementById('securedProfitTryDisplay').innerText = `â‰ˆ â‚º${securedTry.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const pendingContainer = document.getElementById('pendingProfitContainer');
            const pendingDisplay = document.getElementById('pendingProfitDisplay');
            if (realBot.pending_profit > 0.01) {
                pendingContainer.classList.remove('hidden');
                pendingDisplay.innerText = `+$${realBot.pending_profit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } else {
                pendingContainer.classList.add('hidden');
            }

            const pnlPercent = ((totalVal - realBot.initial_balance) / realBot.initial_balance) * 100;
            const pnlEl = document.getElementById('pnlDisplay');
            pnlEl.innerText = (pnlPercent >= 0 ? "+" : "") + pnlPercent.toFixed(2) + "%";
            pnlEl.className = pnlPercent >= 0 ? "text-sm font-bold text-green-400" : "text-sm font-bold text-red-400";

            document.getElementById('avgCostDisplay').innerText = `$${realBot.avg_buy_price.toLocaleString('en-US', { minimumFractionDigits: 0 })}`;
            const budgetPercent = (realBot.budget / totalVal) * 100;
            document.getElementById('budgetBar').style.width = `${budgetPercent}%`;

            // AI Bar
            const aiBar = document.getElementById('aiScoreBar');
            const aiText = document.getElementById('aiScore');

            if (!aiText.innerText.includes("HABER")) {
                const confidence = realBot.ai_confidence;
                aiBar.style.width = `${confidence}%`;

                if (confidence >= 70) {
                    aiBar.className = "h-full bg-green-500 transition-all duration-500 shadow-[0_0_10px_#22c55e]";
                    aiText.innerText = `GÃœÃ‡LÃœ SÄ°NYAL (%${confidence})`;
                    aiText.className = "font-bold text-green-400 neon-text";
                } else if (confidence >= 40) {
                    aiBar.className = "h-full bg-yellow-500 transition-all duration-500";
                    aiText.innerText = `POTANSÄ°YEL (%${confidence})`;
                    aiText.className = "font-bold text-yellow-400";
                } else {
                    aiBar.className = "h-full bg-slate-500 transition-all duration-500";
                    aiText.innerText = realBot.btc_amount > 0 ? "POZÄ°SYON KORUNUYOR" : "SÄ°NYAL BEKLENÄ°YOR";
                    aiText.className = "font-bold text-slate-400";
                }
            }

            // Pie & Equity Update
            assetPieChart.data.datasets[0].data = [realBot.budget, realBot.btc_amount * realBot.current_price];
            assetPieChart.update();

            if (chartManager.currentPeriod === 'live') {
                if (equityLineChart.data.labels.length > 50) {
                    equityLineChart.data.labels.shift();
                    equityLineChart.data.datasets[0].data.shift();
                }
                equityLineChart.data.labels.push('');
                equityLineChart.data.datasets[0].data.push(totalVal);
                equityLineChart.update('none');
            }

            // --- FÄ°YAT GRAFÄ°ÄžÄ° GÃœNCELLEMESÄ° (TÃ¼m Zaman Dilimlerinde CanlÄ± AkÄ±ÅŸ) ---
            // Eskiden burada 'if (chartManager.currentPeriod === 'live')' kontrolÃ¼ vardÄ±.
            // ArtÄ±k geÃ§miÅŸ verisi yÃ¼klÃ¼ olsa bile saÄŸ taraftan canlÄ± veriler eklenmeye devam edecek.

            // Grafik pencere geniÅŸliÄŸi ayarÄ±:
            // CanlÄ± modda kÄ±sa (60), geÃ§miÅŸ modlarda daha geniÅŸ (500) bir tampon tutuyoruz.
            const maxDataPoints = chartManager.currentPeriod === 'live' ? 60 : 500;

            if (priceChart.data.labels.length > maxDataPoints) {
                priceChart.data.labels.shift();
                priceChart.data.datasets[0].data.shift();
                priceChart.data.datasets[1].data.shift();
                priceChart.data.datasets[2].data.shift();
                priceChart.data.datasets[3].data.shift();
            }

            // Veri seti yÃ¼klendiyse ve hazÄ±rsa gÃ¼ncelle
            if (priceChart.data.datasets[0].data.length > 0) {
                priceChart.data.labels.push(''); // Yeni veri iÃ§in boÅŸ etiket
                priceChart.data.datasets[0].data.push(realBot.current_price);

                // MA (Hareketli Ortalama) Ekleme
                // GeÃ§miÅŸ veride mum kapanÄ±ÅŸlarÄ±na gÃ¶re hesaplanan MA ile
                // anlÄ±k tiklerden hesaplanan MA birleÅŸtiriliyor.
                const currentMA = realBot.ma_history.length > 0 ? realBot.ma_history[realBot.ma_history.length - 1] : null;
                priceChart.data.datasets[1].data.push(currentMA);

                // Sinyal Ä°ÅŸleme (AlÄ±m/SatÄ±m ÃœÃ§genleri)
                if (realBot.lastAction && realBot.lastAction.type === 'BUY') {
                    priceChart.data.datasets[2].data.push(realBot.lastAction.price); // AlÄ±m noktasÄ±
                    priceChart.data.datasets[3].data.push(null);
                } else if (realBot.lastAction && realBot.lastAction.type === 'SELL') {
                    priceChart.data.datasets[2].data.push(null);
                    priceChart.data.datasets[3].data.push(realBot.lastAction.price); // SatÄ±m noktasÄ±
                } else {
                    priceChart.data.datasets[2].data.push(null);
                    priceChart.data.datasets[3].data.push(null);
                }
                realBot.lastAction = null; // Sinyali tÃ¼ket

                priceChart.update('none');
            }

            // Logs
            const logsContainer = document.getElementById('systemLogs');
            logsContainer.innerHTML = realBot.logs.map(l => {
                let color = "text-slate-400";
                let tooltip = "Genel sistem bilgilendirmesi.";
                if (l.type === 'success') {
                    color = "text-green-400";
                    if (l.msg.includes("ALIM")) tooltip = "VarlÄ±k satÄ±n alÄ±ndÄ±. Fiyat yÃ¼kseliÅŸi bekleniyor.";
                    else if (l.msg.includes("SATIÅž")) tooltip = "VarlÄ±k satÄ±ldÄ± ve kÃ¢r realize edildi. Bakiye arttÄ±.";
                }
                if (l.type === 'error') { color = "text-red-400"; tooltip = "VarlÄ±k zararÄ±na satÄ±ldÄ±."; }
                if (l.type === 'warning') { color = "text-yellow-400"; }

                return `<div class="mb-1 border-b border-slate-800/50 pb-1 last:border-0 cursor-help hover:bg-slate-800/50 transition px-1 rounded" title="${tooltip}">
                            <span class="text-slate-600 mr-2 font-mono">[${l.time}]</span>
                            <span class="${color}">${l.msg}</span>
                        </div>`;
            }).join('');

            const tableBody = document.getElementById('transactionTable');
            if (realBot.transactions.length > 0) {
                tableBody.innerHTML = realBot.transactions.map(tx => `
                    <tr class="border-b border-slate-800/50 hover:bg-slate-800/30 transition">
                        <td class="py-2 pl-2 text-slate-400 font-mono text-xs">${tx.time}</td>
                        <td class="py-2"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${tx.type === 'BUY' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${tx.type}</span></td>
                        <td class="py-2 text-slate-300">$${tx.price.toLocaleString()}</td>
                        <td class="py-2 text-slate-400 text-xs">${tx.amount.toFixed(6)} BTC</td>
                        <td class="py-2 text-slate-400 text-xs">$${tx.gross.toFixed(2)}</td>
                        <td class="py-2 text-red-400 text-xs">-$${tx.fee.toFixed(2)}</td>
                        <td class="py-2 pr-2 text-right font-bold text-slate-200">$${tx.net.toFixed(2)}</td>
                    </tr>
                `).join('');
            }
        }

        // --- INIT ---
        realBot.log("Sistem BaÅŸlatÄ±lÄ±yor...", "system");
        realBot.log("Binance API BaÄŸlantÄ±sÄ± Kuruluyor...", "warning");
        setInterval(() => { realBot.tick(); }, 1000);

    </script>
</body>

</html>